kind: pipeline
name: Distribute Documentation

steps:

- name: Build The Documentation
  image: squidfunk/mkdocs-material
  pull: if-not-exists
  commands:
    - sed -i 's/##CI_ENVIROMENT_BRANCH##/${DRONE_BRANCH}/g' mkdocs.yml
    - mkdocs build
    - mkdir /drone/tmp
    - cp -rf /drone/src/site/* /drone/tmp/
    - rm -rf *
    - rm -rf .git .drone.yml
    - mv /drone/tmp/* /drone/src/
    - echo 'ErrorDocument 404 ./404.html' >> .htaccess
  when:
    event:
    - push

- name: Transfer Source
  image: appleboy/drone-scp
  settings: 
    host:
      from_secret: scp_host
    user: 
      from_secret: scp_user
    password:
      from_secret: scp_password
    source: 
      - '*'
      - '.*'
    target: /var/www/products/docs.zubzet.de/prod/${DRONE_BRANCH}/
    rm: true
  when:
    event:
    - push
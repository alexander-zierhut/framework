jobs:
  build-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Set up Python and MkDocs
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Install MkDocs Material and mike
        run: pip install mkdocs-material mike

      - name: Build PHP API Documentation
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            phpdoc/phpdoc:3.1 \
            phpdoc -d /app -t /app/docs/api \
                   --ignore /app/adminer \
                   --ignore /app/docs
      - name: Ensure correct permissions on generated files
        run: sudo chmod -R 777 docs

      - name: Configure Git for Deployment
        env:
          SSH_DEPLOY_KEY: ${{ secrets.WEBSITE_DEPLOY_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_DEPLOY_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

          # Add remote for the GitHub Pages repository
          git remote add website git@github.com:zubzet/website.git

      - name: Deploy Documentation (versioned)
        env:
          # Pass the ref name and type to the script (provided by GitHub Actions)
          REF_NAME: ${{ github.ref_name }}
          REF_TYPE: ${{ github.ref_type }}
        run: |
          if [ "$REF_TYPE" = "tag" ]; then
            # On a tagged release -> deploy a new version and update 'latest' alias
            version="$REF_NAME"

            mike deploy --update-aliases "$version" latest \
                        --deploy-prefix docs -b gh-pages -r website -p

            # Set 'latest' as the default version (for /docs base URL redirect)
            mike set-default latest --deploy-prefix docs -b gh-pages -r website -p
          else
            # On main branch push -> deploy/update the 'unstable' docs version
            mike deploy unstable --deploy-prefix docs -b gh-pages -r website -p
          fi
